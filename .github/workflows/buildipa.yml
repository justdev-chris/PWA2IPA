name: Build Ultimate Cat Clicker IPA

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create package.json
      run: |
        echo '{
          "name": "ultimate-cat-clicker",
          "version": "1.0.0", 
          "devDependencies": {
            "@capacitor/cli": "^5.0.0",
            "@capacitor/ios": "^5.0.0"
          }
        }' > package.json
        
    - name: Install dependencies
      run: npm install
      
    - name: Initialize Capacitor iOS
      run: |
        npx cap init "Ultimate Cat Clicker" "com.justchris.ucc" --web-dir www
        npx cap add ios
        
    - name: Copy web assets
      run: npx cap copy ios
      
    - name: Setup iOS icon
      run: |
        if [ -f "ucc-icon.png" ]; then
          echo "ðŸŽ¨ Setting iOS icon from ucc-icon.png"
          mkdir -p ios/App/App/Assets.xcassets/AppIcon.appiconset
          cp ucc-icon.png ios/App/App/Assets.xcassets/AppIcon.appiconset/icon-1024.png
          echo "âœ… iOS icon set!"
        else
          echo "âš ï¸ ucc-icon.png not found - using default icon"
        fi
        
    - name: Build iOS project with detailed output
      run: |
        cd ios/App
        xcodebuild clean
        xcodebuild build -workspace App.xcworkspace -scheme App -configuration Debug CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO -derivedDataPath build | tee xcodebuild.log
        
    - name: Check build results
      run: |
        cd ios/App
        echo "ðŸ” Checking for .app files..."
        find . -name "*.app" -type d 2>/dev/null | while read file; do
          echo "ðŸ“± Found: $file"
          ls -la "$file"
        done
        
        echo "ðŸ“‹ Xcodebuild log summary:"
        if [ -f "xcodebuild.log" ]; then
          tail -20 xcodebuild.log
        fi
        
    - name: Create IPA from any found .app
      run: |
        cd ios/App
        APP_PATH=$(find . -name "*.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          echo "ðŸŽ¯ Creating IPA from: $APP_PATH"
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r UltimateCatClicker.ipa Payload
          echo "âœ… IPA created successfully!"
          ls -lh UltimateCatClicker.ipa
        else
          echo "âŒ CRITICAL: No .app file found after build"
          echo "Debug info:"
          echo "Current dir: $(pwd)"
          echo "Directory structure:"
          find . -type d | head -20
          echo "Build directory:"
          ls -la build/ 2>/dev/null || echo "No build directory"
          exit 1
        fi
        
    - name: Upload unsigned IPA
      uses: actions/upload-artifact@v4
      with:
        name: ultimate-cat-clicker-unsigned-ipa
        path: ios/App/UltimateCatClicker.ipa
        retention-days: 3
