name: Build Ultimate Cat Clicker IPA

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create package.json
      run: |
        echo '{
          "name": "ultimate-cat-clicker",
          "version": "1.0.0", 
          "devDependencies": {
            "@capacitor/cli": "^5.0.0",
            "@capacitor/ios": "^5.0.0"
          }
        }' > package.json
        
    - name: Install dependencies
      run: npm install
      
    - name: Initialize Capacitor iOS
      run: |
        npx cap init "Ultimate Cat Clicker" "com.justchris.ucc" --web-dir www
        npx cap add ios
        
    - name: Copy web assets
      run: npx cap copy ios
      
    - name: Setup iOS icon
      run: |
        if [ -f "ucc-icon.png" ]; then
          echo "üé® Setting iOS icon from ucc-icon.png"
          mkdir -p ios/App/App/Assets.xcassets/AppIcon.appiconset
          cp ucc-icon.png ios/App/App/Assets.xcassets/AppIcon.appiconset/icon-1024.png
          echo "‚úÖ iOS icon set!"
        else
          echo "‚ö†Ô∏è ucc-icon.png not found - using default icon"
        fi
        
    - name: Build iOS project
      run: |
        cd ios/App
        xcodebuild build -workspace App.xcworkspace -scheme App -configuration Debug CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
        
    - name: Debug build structure
      run: |
        cd ios/App
        echo "üìÅ Current directory: $(pwd)"
        echo "üìÅ Listing contents:"
        ls -la
        echo "üìÅ Build directory contents:"
        find build -type f -name "*.app" 2>/dev/null || echo "No .app files in build"
        echo "üìÅ All .app files anywhere:"
        find . -name "*.app" -type d 2>/dev/null || echo "No .app files found"
        
    - name: Create IPA archive
      run: |
        cd ios/App
        APP_PATH=$(find . -name "*.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          echo "üéØ Found app at: $APP_PATH"
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r UltimateCatClicker.ipa Payload
          echo "‚úÖ IPA created successfully!"
          ls -la UltimateCatClicker.ipa
        else
          echo "‚ùå No .app file found - build may have failed"
          exit 1
        fi
        
    - name: Upload unsigned IPA
      uses: actions/upload-artifact@v4
      with:
        name: ultimate-cat-clicker-unsigned-ipa
        path: ios/App/UltimateCatClicker.ipa
        retention-days: 3
