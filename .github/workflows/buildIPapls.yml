name: ucc ipa build

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create package.json
      run: |
        echo '{
          "name": "ultimate-cat-clicker",
          "version": "1.0.0", 
          "devDependencies": {
            "@capacitor/cli": "^5.0.0",
            "@capacitor/ios": "^5.0.0"
          }
        }' > package.json
        
    - name: Install dependencies
      run: npm install
      
    - name: Initialize Capacitor iOS
      run: |
        npx cap init "Ultimate Cat Clicker" "com.justchris.ucc" --web-dir www
        npx cap add ios
        
    - name: Copy web assets
      run: npx cap copy ios
      
    - name: Setup iOS icon properly
      run: |
        if [ -f "ucc-icon.png" ]; then
          echo "üé® Setting up iOS icon properly..."
          
          # Create the iconset directory
          mkdir -p ios/App/App/Assets.xcassets/AppIcon.appiconset
          
          # Copy the main icon
          cp ucc-icon.png ios/App/App/Assets.xcassets/AppIcon.appiconset/AppIcon-512.png
          
          # Create the required Contents.json for iOS
          cat > ios/App/App/Assets.xcassets/AppIcon.appiconset/Contents.json << 'EOF'
        {
          "images": [
            {
              "size": "20x20",
              "idiom": "iphone",
              "filename": "AppIcon-512.png",
              "scale": "2x"
            },
            {
              "size": "20x20",
              "idiom": "iphone",
              "filename": "AppIcon-512.png", 
              "scale": "3x"
            },
            {
              "size": "29x29",
              "idiom": "iphone",
              "filename": "AppIcon-512.png",
              "scale": "2x"
            },
            {
              "size": "29x29",
              "idiom": "iphone",
              "filename": "AppIcon-512.png",
              "scale": "3x"
            },
            {
              "size": "40x40",
              "idiom": "iphone",
              "filename": "AppIcon-512.png",
              "scale": "2x"
            },
            {
              "size": "40x40",
              "idiom": "iphone",
              "filename": "AppIcon-512.png",
              "scale": "3x"
            },
            {
              "size": "60x60",
              "idiom": "iphone",
              "filename": "AppIcon-512.png",
              "scale": "2x"
            },
            {
              "size": "60x60",
              "idiom": "iphone",
              "filename": "AppIcon-512.png",
              "scale": "3x"
            },
            {
              "size": "1024x1024",
              "idiom": "ios-marketing",
              "filename": "AppIcon-512.png",
              "scale": "1x"
            }
          ],
          "info": {
            "version": 1,
            "author": "xcode"
          }
        }
        EOF
          
          echo "‚úÖ iOS icon setup complete!"
        else
          echo "‚ö†Ô∏è ucc-icon.png not found - using default Capacitor icon"
        fi
        
    - name: Build iOS project
      run: |
        cd ios/App
        xcodebuild clean
        xcodebuild build -workspace App.xcworkspace -scheme App -configuration Debug CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO -derivedDataPath build
        
    - name: Debug build structure
      run: |
        cd ios/App
        echo "üîç Checking for .app files..."
        find . -name "*.app" -type d 2>/dev/null | while read file; do
          echo "üì± Found: $file"
          ls -la "$file"
        done
        
    - name: Create IPA from any found .app
      run: |
        cd ios/App
        APP_PATH=$(find . -name "*.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          echo "üéØ Creating IPA from: $APP_PATH"
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r UltimateCatClicker.ipa Payload
          echo "‚úÖ IPA created successfully!"
          ls -lh UltimateCatClicker.ipa
        else
          echo "‚ùå CRITICAL: No .app file found - build may have failed"
          echo "Debug info:"
          echo "Current dir: $(pwd)"
          echo "Directory structure:"
          find . -type d | head -20
          exit 1
        fi
        
    - name: Upload unsigned IPA
      uses: actions/upload-artifact@v4
      with:
        name: ultimate-cat-clicker-unsigned-ipa
        path: ios/App/UltimateCatClicker.ipa
        retention-days: 3
